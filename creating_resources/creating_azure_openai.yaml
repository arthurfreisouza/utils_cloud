name: Create Azure OpenAI Resource with Role Assignment

trigger: none

parameters:
- name: location
  type: string
  default: "eastus"
- name: RESOURCE_GROUP
  type: string
  default: "projArthurreis"
- name: openAIName
  displayName: 'Azure OpenAI Resource Name'
  type: string
- name: sku
  displayName: 'Azure OpenAI SKU'
  type: string
  default: 'S0'
- name: role
  displayName: 'Role to Assign'
  type: string
  default: 'Cognitive Services OpenAI User'
- name: principalId
  displayName: 'Principal ID (Object ID) for Role Assignment'
  type: string

variables:
- group: Arthur_VG

stages:
- stage: CheckResources
  displayName: 'Check Resource Group Stage'
  jobs:
  - job: CheckResourceGroup
    displayName: 'Check or Create Resource Group'
    steps:
    - task: AzureCLI@2
      displayName: 'Check or Create Resource Group'
      inputs:
        azureSubscription: $(service_conn)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: >-
          echo "Checking if resource group '${{ parameters.RESOURCE_GROUP }}' exists..."

          exists=$(az group exists --name ${{ parameters.RESOURCE_GROUP }})

          echo "az returned: $exists"

          if [ "$exists" = "false" ]; then
            echo "##[warning] Resource group does not exist. Creating it now..."
            az group create --name ${{ parameters.RESOURCE_GROUP }} --location ${{ parameters.location }} --only-show-errors
            echo "✅ Resource group created successfully."
          else
            echo "✅ Resource group exists."
          fi

- stage: ValidateOpenAI
  displayName: 'Validate Azure OpenAI Configuration'
  jobs:
  - job: ValidateOpenAIName
    displayName: 'Validate Azure OpenAI Name'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Validate Azure OpenAI Name Format'
      inputs:
        azureSubscription: $(service_conn)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          if [[ ! "${{ parameters.openAIName }}" =~ ^[a-zA-Z0-9-]{2,64}$ ]]; then
            echo "##[error] Azure OpenAI name must be 2-64 alphanumeric characters and hyphens"
            exit 1
          fi
          echo "✅ Azure OpenAI name validation passed"

- stage: CreateOpenAI
  displayName: 'Create Azure OpenAI Resource'
  jobs:
  - job: CreateOpenAIJob
    displayName: 'Create Azure OpenAI'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Create Azure OpenAI Resource'
      inputs:
        azureSubscription: $(service_conn)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: >
          echo "Creating Azure OpenAI resource: ${{ parameters.openAIName }}"

          az cognitiveservices account create \
            --name "${{ parameters.openAIName }}" \
            --resource-group "${{ parameters.RESOURCE_GROUP }}" \
            --location "${{ parameters.location }}" \
            --kind OpenAI \
            --sku "${{ parameters.sku }}" \
            --yes \
            --output table
          
          echo "✅ Azure OpenAI resource created successfully"



- stage: WaitForProvisioning
  displayName: 'Wait for Azure OpenAI Provisioning'
  jobs:
  - job: WaitJob
    displayName: 'Wait 30 seconds'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Bash@3
      displayName: 'Sleep for 30 seconds'
      inputs:
        targetType: 'inline'
        script: |
          echo "Waiting 30 seconds for Azure OpenAI resource to be fully provisioned..."
          sleep 30
          echo "✅ Wait completed"

- stage: AssignRole
  displayName: 'Assign Role to Principal'
  jobs:
  - job: AssignRoleJob
    displayName: 'Assign Role to Azure OpenAI'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Assign Role to Principal'
      inputs:
        azureSubscription: $(service_conn)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: >
          echo "Assigning role '${{ parameters.role }}' to principal '${{ parameters.principalId }}'"

          OPENAI_RESOURCE_ID=$(az cognitiveservices account show \
            --name "${{ parameters.openAIName }}" \
            --resource-group "${{ parameters.RESOURCE_GROUP }}" \
            --query id -o tsv)
          
          az role assignment create \
            --assignee "${{ parameters.principalId }}" \
            --role "${{ parameters.role }}" \
            --scope "$OPENAI_RESOURCE_ID" \
            --output table
          
          echo "✅ Role assignment completed successfully"

- stage: SmokeTest
  displayName: 'Smoke Test Azure OpenAI Resource'
  jobs:
  - job: SmokeTestJob
    displayName: 'Verify Azure OpenAI Exists'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Check Azure OpenAI Exists'
      inputs:
        azureSubscription: $(service_conn)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Verifying Azure OpenAI resource '${{ parameters.openAIName }}' exists..."

          if az cognitiveservices account show --name "${{ parameters.openAIName }}" --resource-group "${{ parameters.RESOURCE_GROUP }}" &> /dev/null; then
            echo "✅ Azure OpenAI Resource '${{ parameters.openAIName }}' exists."
            
            echo "========================================"
            echo "Azure OpenAI Resource Details:"
            echo "========================================"
            az cognitiveservices account show \
              --name "${{ parameters.openAIName }}" \
              --resource-group "${{ parameters.RESOURCE_GROUP }}" \
              --output table
            
            echo ""
            echo "Azure OpenAI Configuration:"
            echo "- Name: ${{ parameters.openAIName }}"
            echo "- Resource Group: ${{ parameters.RESOURCE_GROUP }}"
            echo "- Location: ${{ parameters.location }}"
            echo "- SKU: ${{ parameters.sku }}"
            echo "- Role Assigned: ${{ parameters.role }}"
            echo "- Principal ID: ${{ parameters.principalId }}"
            
            echo "========================================"
          else
            echo "❌ ##[error] ERROR: Azure OpenAI Resource '${{ parameters.openAIName }}' does not exist in resource group ${{ parameters.RESOURCE_GROUP }} or an error occurred." >&2
            exit 1
          fi

          echo "✅ Smoke test completed successfully."
